<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>4. NGINX Kubernetes Ingress Controller | Examples</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="4. NGINX Kubernetes Ingress Controller | Examples"/>
  <meta name="product" content="F5 NGINX and Red Hat OpenShift Demo"/>
  <meta name="version" content="latest"/>
  <meta name="updated_date"  content="2022-07-23 21:22:39"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 NGINX and Red Hat OpenShift Demo" content="latest"/>


  <!-- Version selector meta tags-->
  <meta name="version_meta_path" content="/training/community/template/versions.json">
  <meta name="project_safe" content="F5NGINXandRedHatOpenShiftDemo">
  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4. NGINX Kubernetes Ingress Controller | Examples &#8212; F5 NGINX and Red Hat OpenShift Demo </title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="3. Arcadia Application | Deployment" href="lab02.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
        <h5>F5 NGINX and Red Hat OpenShift Demo latest </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../class1.html">Class 1: RHPDS Lab - NGINX Kubernetes Ingress Controller For OpenShift</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="module1.html">NGINX Kubernetes Ingress Controller For OpenShift</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lab00.html">1. Quick Overview of How to Interact With OpenShift</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab01.html">2. NGINX Kubernetes Ingress Controller | Deployment</a></li>
<li class="toctree-l3"><a class="reference internal" href="lab02.html">3. Arcadia Application | Deployment</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4. NGINX Kubernetes Ingress Controller | Examples</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">4. NGINX Kubernetes Ingress Controller | Examples</a></li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 NGINX and Red Hat OpenShift Demo</a>
              &gt; <a href="../class1.html">Class 1: RHPDS Lab - NGINX Kubernetes Ingress Controller For OpenShift</a>
              &gt; <a href="module1.html">NGINX Kubernetes Ingress Controller For OpenShift</a>

          <span class="right">
             <a href="../../_sources/class1/module1/lab03.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/ericzji/nginx-openshift-lab">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="nginx-kubernetes-ingress-controller-examples">
<h1><span class="section-number">4. </span>NGINX Kubernetes Ingress Controller | Examples<a class="headerlink" href="#nginx-kubernetes-ingress-controller-examples" title="Permalink to this heading">¶</a></h1>
<p>Included below are several examples of NGINX Ingress Controller deployments. It is recommended that you progress through building on top of each other. Going this way highlights the lifecycle of container-based services that will evolve.</p>
<p><img alt="image51" src="../../_images/image51.png" /></p>
<p>The VirtualServer and VirtualServerRoute resources are new load-balancing configurations introduced in release 1.5 as an alternative to the Ingress resource. The resources enable use cases not supported with the Ingress resource, such as traffic splitting and advanced content-based routing. The resources are implemented as <a class="reference external" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resources</a>.</p>
<p>A custom resource is an extension of the Kubernetes API that is not necessarily available in a default Kubernetes installation. It represents a customization of a particular Kubernetes installation. However, many core Kubernetes functions are now built using custom resources, making Kubernetes more modular.</p>
<p>Custom resources can appear and disappear in a running cluster through dynamic registration, and cluster admins can update custom resources independently of the cluster itself. Once a custom resource is installed, users can create and access its objects using kubectl, just as they do for built-in resources like Pods.</p>
<p><strong>NGINX Ingress Controller Examples</strong>:</p>
<ul class="simple">
<li>Basic: This is a simple layer 7 routing ingress, taking our EXTERNAL-IP address and moving clients to Arcadia Application</li>
<li>HTTPS: Layer 7 routing ingress with TLS, TLS secret is stored in Kubernetes as a TLS secret</li>
<li>HTTPS with Active Monitors: HTTPS + Active Health Monitors to Pods</li>
<li>HTTPS with Active Monitors, Caching: HTTPS + Active Health Monitors + Caching for site content</li>
<li>HTTPS with Active Monitors, Caching, mTLS: HTTPS + Active Health Monitors + Caching + mTLS for client ca challenge</li>
</ul>
<ol class="arabic">
<li><p class="first">Basic</p>
<p>Create NGINX Ingress Controller with Basic HTTP:</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: arcadia
spec:
  host: $nginx_ingress
  upstreams:
  - name: arcadia-main
    service: arcadia-main
    port: 80
  - name: arcadia-app2
    service: arcadia-app2
    port: 80
  - name: arcadia-app3
    service: arcadia-app3
    port: 80
  routes:
  - path: /
    action:
      pass: arcadia-main
  - path: /app2
    action:
      proxy:
        upstream: arcadia-app2
        rewritePath: /
  - path: /app3
    action:
      proxy:
        upstream: arcadia-app3
        rewritePath: /
EOF
</pre></div>
</div>
<p>Example:</p>
<p><img alt="image31" src="../../_images/image31.png" /></p>
<p>NGINX Dashboard should be updated reflecting the new services discovered</p>
<p>NGINX Dashboard URL (replace with the dashboard-nginx-ingress EXTERNAL-IP): <code class="docutils literal notranslate"><span class="pre">http://EXTERNAL-IP/dashboard.html</span></code></p>
<p>Example:</p>
<p><img alt="image32" src="../../_images/image32.png" /></p>
<p>Arcadia application is now exposed through the NGINX Ingress Controller on HTTP!</p>
<p>NGINX Ingress Controller URL (replace with the nginx-ingress EXTERNAL-IP): <code class="docutils literal notranslate"><span class="pre">http://EXTERNAL-IP/</span></code></p>
<p>Example:</p>
<p><img alt="image33" src="../../_images/image33.png" /></p>
</li>
<li><p class="first">HTTPS</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no change to the Dashboard when using HTTPS. However, the Ingress will now listen on both port 80 and port 443</p>
</div>
<p>TLS Secrets stored in Kubernetes can be referenced with NGINX Ingress Controller. First, we need to install them into Kubernetes.</p>
<p>Step 1. Create Kubernetes TLS Secret</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: arcadia-secret
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURMakNDQWhZQ0NRREFPRjl0THNhWFdqQU5CZ2txaGtpRzl3MEJBUXNGQURCYU1Rc3dDUVlEVlFRR0V3SlYKVXpFTE1Ba0dBMVVFQ0F3Q1EwRXhJVEFmQmdOVkJBb01HRWx1ZEdWeWJtVjBJRmRwWkdkcGRITWdVSFI1SUV4MApaREViTUJrR0ExVUVBd3dTWTJGbVpTNWxlR0Z0Y0d4bExtTnZiU0FnTUI0WERURTRNRGt4TWpFMk1UVXpOVm9YCkRUSXpNRGt4TVRFMk1UVXpOVm93V0RFTE1Ba0dBMVVFQmhNQ1ZWTXhDekFKQmdOVkJBZ01Ba05CTVNFd0h3WUQKVlFRS0RCaEpiblJsY201bGRDQlhhV1JuYVhSeklGQjBlU0JNZEdReEdUQVhCZ05WQkFNTUVHTmhabVV1WlhoaApiWEJzWlM1amIyMHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDcDZLbjdzeTgxCnAwanVKL2N5ayt2Q0FtbHNmanRGTTJtdVpOSzBLdGVjcUcyZmpXUWI1NXhRMVlGQTJYT1N3SEFZdlNkd0kyaloKcnVXOHFYWENMMnJiNENaQ0Z4d3BWRUNyY3hkam0zdGVWaVJYVnNZSW1tSkhQUFN5UWdwaW9iczl4N0RsTGM2SQpCQTBaalVPeWwwUHFHOVNKZXhNVjczV0lJYTVyRFZTRjJyNGtTa2JBajREY2o3TFhlRmxWWEgySTVYd1hDcHRDCm42N0pDZzQyZitrOHdnemNSVnA4WFprWldaVmp3cTlSVUtEWG1GQjJZeU4xWEVXZFowZXdSdUtZVUpsc202OTIKc2tPcktRajB2a29QbjQxRUUvK1RhVkVwcUxUUm9VWTNyemc3RGtkemZkQml6Rk8yZHNQTkZ4MkNXMGpYa05MdgpLbzI1Q1pyT2hYQUhBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFLSEZDY3lPalp2b0hzd1VCTWRMClJkSEliMzgzcFdGeW5acS9MdVVvdnNWQTU4QjBDZzdCRWZ5NXZXVlZycTVSSWt2NGxaODFOMjl4MjFkMUpINnIKalNuUXgrRFhDTy9USkVWNWxTQ1VwSUd6RVVZYVVQZ1J5anNNL05VZENKOHVIVmhaSitTNkZBK0NuT0Q5cm4yaQpaQmVQQ0k1ckh3RVh3bm5sOHl3aWozdnZRNXpISXV5QmdsV3IvUXl1aTlmalBwd1dVdlVtNG52NVNNRzl6Q1Y3ClBwdXd2dWF0cWpPMTIwOEJqZkUvY1pISWc4SHc5bXZXOXg5QytJUU1JTURFN2IvZzZPY0s3TEdUTHdsRnh2QTgKN1dqRWVxdW5heUlwaE1oS1JYVmYxTjM0OWVOOThFejM4Zk9USFRQYmRKakZBL1BjQytHeW1lK2lHdDVPUWRGaAp5UkU9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBcWVpcCs3TXZOYWRJN2lmM01wUHJ3Z0pwYkg0N1JUTnBybVRTdENyWG5LaHRuNDFrCkcrZWNVTldCUU5semtzQndHTDBuY0NObzJhN2x2S2wxd2k5cTIrQW1RaGNjS1ZSQXEzTVhZNXQ3WGxZa1YxYkcKQ0pwaVJ6ejBza0lLWXFHN1BjZXc1UzNPaUFRTkdZMURzcGRENmh2VWlYc1RGZTkxaUNHdWF3MVVoZHErSkVwRwp3SStBM0kreTEzaFpWVng5aU9WOEZ3cWJRcCt1eVFvT05uL3BQTUlNM0VWYWZGMlpHVm1WWThLdlVWQ2cxNWhRCmRtTWpkVnhGbldkSHNFYmltRkNaYkp1dmRySkRxeWtJOUw1S0Q1K05SQlAvazJsUkthaTAwYUZHTjY4NE93NUgKYzMzUVlzeFR0bmJEelJjZGdsdEkxNURTN3lxTnVRbWF6b1Z3QndJREFRQUJBb0lCQVFDUFNkU1luUXRTUHlxbApGZlZGcFRPc29PWVJoZjhzSStpYkZ4SU91UmF1V2VoaEp4ZG01Uk9ScEF6bUNMeUw1VmhqdEptZTIyM2dMcncyCk45OUVqVUtiL1ZPbVp1RHNCYzZvQ0Y2UU5SNThkejhjbk9SVGV3Y290c0pSMXBuMWhobG5SNUhxSkpCSmFzazEKWkVuVVFmY1hackw5NGxvOUpIM0UrVXFqbzFGRnM4eHhFOHdvUEJxalpzVjdwUlVaZ0MzTGh4bndMU0V4eUZvNApjeGI5U09HNU9tQUpvelN0Rm9RMkdKT2VzOHJKNXFmZHZ5dGdnOXhiTGFRTC94MGtwUTYyQm9GTUJEZHFPZVBXCktmUDV6WjYvMDcvdnBqNDh5QTFRMzJQem9idWJzQkxkM0tjbjMyamZtMUU3cHJ0V2wrSmVPRmlPem5CUUZKYk4KNHFQVlJ6NWhBb0dCQU50V3l4aE5DU0x1NFArWGdLeWNrbGpKNkY1NjY4Zk5qNUN6Z0ZScUowOXpuMFRsc05ybwpGVExaY3hEcW5SM0hQWU00MkpFUmgySi9xREZaeW5SUW8zY2czb2VpdlVkQlZHWTgrRkkxVzBxZHViL0w5K3l1CmVkT1pUUTVYbUdHcDZyNmpleHltY0ppbS9Pc0IzWm5ZT3BPcmxEN1NQbUJ2ek5MazRNRjZneGJYQW9HQkFNWk8KMHA2SGJCbWNQMHRqRlhmY0tFNzdJbUxtMHNBRzR1SG9VeDBlUGovMnFyblRuT0JCTkU0TXZnRHVUSnp5K2NhVQprOFJxbWRIQ2JIelRlNmZ6WXEvOWl0OHNaNzdLVk4xcWtiSWN1YytSVHhBOW5OaDFUanNSbmU3NFowajFGQ0xrCmhIY3FIMHJpN1BZU0tIVEU4RnZGQ3haWWRidUI4NENtWmlodnhicFJBb0dBSWJqcWFNWVBUWXVrbENkYTVTNzkKWVNGSjFKelplMUtqYS8vdER3MXpGY2dWQ0thMzFqQXdjaXowZi9sU1JxM0hTMUdHR21lemhQVlRpcUxmZVpxYwpSMGlLYmhnYk9jVlZrSkozSzB5QXlLd1BUdW14S0haNnpJbVpTMGMwYW0rUlk5WUdxNVQ3WXJ6cHpjZnZwaU9VCmZmZTNSeUZUN2NmQ21mb09oREN0enVrQ2dZQjMwb0xDMVJMRk9ycW40M3ZDUzUxemM1em9ZNDR1QnpzcHd3WU4KVHd2UC9FeFdNZjNWSnJEakJDSCtULzZzeXNlUGJKRUltbHpNK0l3eXRGcEFOZmlJWEV0LzQ4WGY2ME54OGdXTQp1SHl4Wlp4L05LdER3MFY4dlgxUE9ucTJBNWVpS2ErOGpSQVJZS0pMWU5kZkR1d29seHZHNmJaaGtQaS80RXRUCjNZMThzUUtCZ0h0S2JrKzdsTkpWZXN3WEU1Y1VHNkVEVXNEZS8yVWE3ZlhwN0ZjanFCRW9hcDFMU3crNlRYcDAKWmdybUtFOEFSek00NytFSkhVdmlpcS9udXBFMTVnMGtKVzNzeWhwVTl6WkxPN2x0QjBLSWtPOVpSY21Vam84UQpjcExsSE1BcWJMSjhXWUdKQ2toaVd4eWFsNmhZVHlXWTRjVmtDMHh0VGwvaFVFOUllTktvCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
EOF
</pre></div>
</div>
<p>Step 2. Create NGINX Ingress Controller with HTTPS:</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: arcadia
spec:
  host: $nginx_ingress
  tls:
    secret: arcadia-secret
  upstreams:
  - name: arcadia-main
    service: arcadia-main
    port: 80
  - name: arcadia-app2
    service: arcadia-app2
    port: 80
  - name: arcadia-app3
    service: arcadia-app3
    port: 80
  routes:
  - path: /
    action:
      pass: arcadia-main
  - path: /app2
    action:
      pass: arcadia-app2
  - path: /app3
    action:
      pass: arcadia-app3
EOF
</pre></div>
</div>
<p>Arcadia application is now exposed through the NGINX Ingress Controller on HTTPS!</p>
<p>NGINX Ingress Controller URL (replace with the nginx-ingress EXTERNAL-IP): <code class="docutils literal notranslate"><span class="pre">https://EXTERNAL-IP/</span></code> or <code class="docutils literal notranslate"><span class="pre">http://EXTERNAL-IP/</span></code></p>
</li>
<li><p class="first">HTTPS with Active Monitors</p>
<p>NGINX Plus can periodically check the health of upstream servers by sending special health-check requests to each server and verifying the correct response.</p>
<p>Create NGINX Ingress Controller with HTTPS with Active Monitors:</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: arcadia
spec:
  host: $nginx_ingress
  tls:
    secret: arcadia-secret
    redirect:
      enable: true
  upstreams:
  - name: arcadia-main
    service: arcadia-main
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  - name: arcadia-app2
    service: arcadia-app2
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  - name: arcadia-app3
    service: arcadia-app3
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  routes:
  - path: /
    action:
      pass: arcadia-main
  - path: /api/
    action:
      pass: arcadia-app2
  - path: /app3/
    action:
      pass: arcadia-app3
EOF
</pre></div>
</div>
<p>Example:</p>
<p><img alt="image35" src="../../_images/image35.png" /></p>
<p>NGINX Dashboard should be updated reflecting the active monitors</p>
<p>NGINX Dashboard URL (replace with the dashboard-nginx-ingress EXTERNAL-IP): <code class="docutils literal notranslate"><span class="pre">http://EXTERNAL-IP/dashboard.html#upstreams</span></code></p>
<p>Example:</p>
<p><img alt="image36" src="../../_images/image36.png" /></p>
<p>Arcadia application is now exposed through the NGINX Ingress Controller only on HTTP with monitors!</p>
<p>NGINX Ingress Controller URL (replace with the nginx-ingress EXTERNAL-IP): <code class="docutils literal notranslate"><span class="pre">https://EXTERNAL-IP/</span></code></p>
</li>
<li><p class="first">HTTPS with Active Monitors, Caching</p>
<p>A content cache sits in between a client and an <strong>origin server</strong>, and saves copies of all the content it sees. If a client requests content that the cache has stored, it returns the content directly without contacting the origin server. This improves performance as the content cache is closer to the client and more efficiently uses the application servers because they do not have to generate pages from scratch each time.</p>
<p>Step 1. Create NGINX Ingress Controller Caching Path:</p>
<p>From OpenShift Console, Click Operators -&gt; Installed Operator in the left navigation column. On the page that opens, click the Nginx Ingress Controller link in the Provided APIs column.
Select “my-nginx-ingress-controller”, and then click YAML to include the following ConfigMap under Spec:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">:</span>
  <span class="n">annotations</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">entries</span><span class="p">:</span>
    <span class="n">http</span><span class="o">-</span><span class="n">snippets</span><span class="p">:</span> <span class="o">&gt;</span>
      <span class="n">proxy_cache_path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">a</span> <span class="n">levels</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span> <span class="n">keys_zone</span><span class="o">=</span><span class="n">my_cache</span><span class="p">:</span><span class="mi">10</span><span class="n">m</span>
      <span class="n">max_size</span><span class="o">=</span><span class="mi">100</span><span class="n">m</span> <span class="n">inactive</span><span class="o">=</span><span class="mi">60</span><span class="n">m</span> <span class="n">use_temp_path</span><span class="o">=</span><span class="n">off</span><span class="p">;</span>
    <span class="n">proxy</span><span class="o">-</span><span class="n">protocol</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span>
    <span class="n">real</span><span class="o">-</span><span class="n">ip</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">proxy_protocol</span>
    <span class="nb">set</span><span class="o">-</span><span class="n">real</span><span class="o">-</span><span class="n">ip</span><span class="o">-</span><span class="n">from</span><span class="p">:</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">0</span>
</pre></div>
</div>
<p>In the same yaml file, we also need to add two annotations to the AWS LoadBalancer service. The annonations specify TCP layer 4 proxying: the ELB forwards traffic without modifying the headers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span><span class="p">:</span>
  <span class="n">externalIPs</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">customPorts</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">loadBalancerIP</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
  <span class="n">annotations</span><span class="p">:</span>
    <span class="n">service</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">balancer</span><span class="o">-</span><span class="n">backend</span><span class="o">-</span><span class="n">protocol</span><span class="p">:</span> <span class="n">tcp</span>
    <span class="n">service</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">balancer</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">protocol</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span>
</pre></div>
</div>
<p>Click Save, and Reload</p>
<p>Step 2.  NGINX Dashboard should be updated with the cache location</p>
<p>Example:</p>
<p><img alt="image38" src="../../_images/image38.png" /></p>
<p>Step 3. Create NGINX Ingress Controller with HTTPS with Active Monitors, Caching:</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: arcadia
spec:
  server-snippets: |
    proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
    proxy_cache_valid any 30s;
  host: $nginx_ingress
  tls:
    secret: arcadia-secret
    redirect:
      enable: true
  upstreams:
  - name: arcadia-main
    service: arcadia-main
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  - name: arcadia-app2
    service: arcadia-app2
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  - name: arcadia-app3
    service: arcadia-app3
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  routes:
  - path: /
    location-snippets: |
      proxy_cache my_cache;
      add_header X-Cache-Status \$upstream_cache_status;
    action:
      pass: arcadia-main
  - path: /api/
    action:
      pass: arcadia-app2
  - path: /app3/
    action:
      pass: arcadia-app3
EOF
</pre></div>
</div>
<p>Example:</p>
<p><img alt="image39" src="../../_images/image39.png" /></p>
<p>Arcadia application is now exposed through the NGINX Ingress Controller only on HTTP with monitors and caching!</p>
<p>NGINX Ingress Controller URL (replace with the nginx-ingress EXTERNAL-IP): <code class="docutils literal notranslate"><span class="pre">https://EXTERNAL-IP/</span></code></p>
</li>
</ol>
<ol class="arabic">
<li><p class="first">HTTPS with Active Monitors, Caching, mTLS</p>
<p>NGINX Ingress Controller can participate in the mTLS cert exchange with services.</p>
<p>By default, the TLS protocol only proves the identity of the server to the client using X.509 certificates, and the authentication of the client to the server is left to the application layer. TLS also offers client-to-server authentication using client-side X.509 authentication. As it requires provisioning of the certificates to the clients and involves a less user-friendly experience, it is rarely used in end-user applications.</p>
<p>Mutual TLS authentication (<strong>mTLS</strong>) is much more widespread in business-to-business (B2B) applications, where a limited number of programmatic and homogeneous clients are connecting to specific web services, the operational burden is limited, and security requirements are usually much higher as compared to consumer environments.</p>
<p>Step 1. Create the Arcadia mTLS secret in Kubernetes:</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
kind: Secret
metadata:
  name: arcadia-mtls-secret
apiVersion: v1
type: nginx.org/ca
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQvVENDQXVXZ0F3SUJBZ0lVSzdhbU14OFlLWG1BVG51SkZETDlWS2ZUR2ZNd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dZMHhDekFKQmdOVkJBWVRBbFZUTVFzd0NRWURWUVFJREFKRFFURVdNQlFHQTFVRUJ3d05VMkZ1SUVaeQpZVzVqYVhOamJ6RU9NQXdHQTFVRUNnd0ZUa2RKVGxneEREQUtCZ05WQkFzTUEwdEpRekVXTUJRR0ExVUVBd3dOCmEybGpMbTVuYVc1NExtTnZiVEVqTUNFR0NTcUdTSWIzRFFFSkFSWVVhM1ZpWlhKdVpYUmxjMEJ1WjJsdWVDNWoKYjIwd0hoY05NakF3T1RFNE1qQXlOVEkyV2hjTk16QXdPVEUyTWpBeU5USTJXakNCalRFTE1Ba0dBMVVFQmhNQwpWVk14Q3pBSkJnTlZCQWdNQWtOQk1SWXdGQVlEVlFRSERBMVRZVzRnUm5KaGJtTnBjMk52TVE0d0RBWURWUVFLCkRBVk9SMGxPV0RFTU1Bb0dBMVVFQ3d3RFMwbERNUll3RkFZRFZRUUREQTFyYVdNdWJtZHBibmd1WTI5dE1TTXcKSVFZSktvWklodmNOQVFrQkZoUnJkV0psY201bGRHVnpRRzVuYVc1NExtTnZiVENDQVNJd0RRWUpLb1pJaHZjTgpBUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTmFINVRzaTZzaUFsU085dEJnYmY3VVRwcWowMUhRTlQ2UjhtQy9pCjhLYXFaSW9XSUdvN2xhTW9xTDYydTc4ay9WOHM2Z0FJaU1DSzBjekFvTFhNSnlJQkxQeTg4Yzdtc2xwZXgxTkEKVmRtMkVTVkN6bVlERE1TT3FpVmszWmpYeC9URmo2QzhNRFhhRkZUWFg1dWdtbWdscnFCWlh0OVI5VVBwVTJMNwo1bEZ0NlJ2R3VGczgvbVZORVR5c1A0SFhCWlh2ZE9mdG1YWUkvK01hOW5CMzIzNjdmcTI0L0RKZ2YvK2xRbUsxCkJLR3poSTZSc1pSSmdWOXdpK1VuZTBYNjlaS2lLOFdXU3lZS252YnRrcHZuTDA2dGNJaXJZNi80UzZ4Sm1HRVQKZEJUNmVxc0NoSUpQUStWSEp5dTROdnV6WmVCUXpGdmMwNytnUGZkVWZra1FXODhDQXdFQUFhTlRNRkV3SFFZRApWUjBPQkJZRUZKUGdhcnFYa00rdEJ0djVhdndTUWhUQmpTU2VNQjhHQTFVZEl3UVlNQmFBRkpQZ2FycVhrTSt0CkJ0djVhdndTUWhUQmpTU2VNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUIKQUl3WXpoY0s4OWtRL0xGWjZFRHgrQWp2bnJTVSs1cmdwQkgrRjVTNUUyY3pXOE5rNXhySnl0Y0ZUbUtlKzZScwpENHlxeTZSVVFEeWNYaDlPelBjbzgzYTBoeFlCZ1M5MWtJa25wYWF4dndLRDJleWc3UGNnK1lkS1FhZFlMcUY0CmI3cWVtc1FVVkpOWHdkZS9VanRBejlEOTh4dngwM2hQY2Qwb2dzUUhWZ21BZVpFd2l3UzFmTy9WNUE4dTl3MEkKcHlJRTVReXlHcHNpS2dpalpiMmhrS05RVHVJcEhiVnFydVA4eEV6TlFnamhkdS9uUW5OYy9lRUltVUlrQkFUVQpiSHdQc2xwYzVhdVV1TXJxR3lEQ0p2QUJpV3J2SmE3Yi9XcmtDT3FUWVhtR2NGM0w1ZU9FeTBhYkp0M2NNcSs5CnJLTUNVQWlkNG0yNEthWnc3OUk2anNBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
EOF
</pre></div>
</div>
<p>Step 2. Create the custom resource policy for mTLS</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
apiVersion: k8s.nginx.org/v1
kind: Policy
metadata:
  name: arcadia-mtls-policy
spec:
  ingressMTLS:
    clientCertSecret: arcadia-mtls-secret
    verifyClient: &quot;on&quot;
    verifyDepth: 1
EOF
</pre></div>
</div>
<p>Step 3. Create NGINX Ingress Controller with HTTPS with Active Monitors, Caching:</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | oc apply -f -
apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: arcadia
spec:
  server-snippets: |
    proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
    proxy_cache_valid any 30s;
  host: $nginx_ingress
  tls:
    secret: arcadia-secret
    redirect:
      enable: true
  policies:
  - name: arcadia-mtls-policy
  upstreams:
  - name: arcadia-main
    service: arcadia-main
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  - name: arcadia-app2
    service: arcadia-app2
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  - name: arcadia-app3
    service: arcadia-app3
    port: 80
    healthCheck:
      enable: true
      port: 8080
      interval: 20s
      jitter: 3s
      fails: 5
      passes: 5
      statusMatch: &quot;! 500&quot;
  routes:
  - path: /
    location-snippets: |
      proxy_cache my_cache;
      add_header X-Cache-Status \$upstream_cache_status;
    action:
      pass: arcadia-main
  - path: /api/
    action:
      pass: arcadia-app2
  - path: /app3/
    action:
      pass: arcadia-app3
EOF
</pre></div>
</div>
<p>Example:</p>
<p><img alt="image42" src="../../_images/image42.png" /></p>
<p>Arcadia application is now exposed through the NGINX Ingress Controller with mTLS!</p>
<p>NGINX Ingress Controller URL (replace with your nginx-ingress EXTERNAL-IP): <code class="docutils literal notranslate"><span class="pre">https://EXTERNAL-IP/</span></code></p>
<p><img alt="image43" src="../../_images/image43.png" /></p>
<p>Step 4. After mTLS is enabled, you will need to present a certificate that NGINX Ingress Controller can validate against its CA</p>
<p>In the terminal window, copy the below text and paste+enter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/f5devcentral/f5-digital-customer-engagement-center/main/solutions/delivery/application_delivery_controller/nginx/kic/templates/client-cert.pem
wget https://raw.githubusercontent.com/f5devcentral/f5-digital-customer-engagement-center/main/solutions/delivery/application_delivery_controller/nginx/kic/templates/client-key.pem

curl --insecure https://$nginx_ingress/ --cert client-cert.pem --key client-key.pem
</pre></div>
</div>
<p>Example:</p>
<p><img alt="image44" src="../../_images/image44.png" /></p>
</li>
<li><p class="first">The fun does not need to stop yet!</p>
<p>The NGINX product team creates several examples of using NGINX VirtualServers, Ingress, and Configmaps, all of the examples in the <a class="reference external" href="https://github.com/nginxinc/kubernetes-ingress/tree/master/examples-of-custom-resources">nginxinc GitHub repository</a> will also work in this environment.</p>
</li>
<li><p class="first">NGINX Examples have all been completed</p>
</li>
</ol>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab02.html" title="3. Arcadia Application | Deployment" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>